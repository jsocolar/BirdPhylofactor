{
    "collab_server" : "",
    "contents" : "##Phylofactorization of Costa Rican birds data\n\n### If you haven't already installed the updated phylofactor package, run the 5 lines below\n# source(\"https://bioconductor.org/biocLite.R\")\n# biocLite(\"ggtree\")\n# biocLite(\"Biostrings\")\n# install.packages('devtools')\n# devtools::install_github('reptalex/phylofactor')\n\nlibrary(phylofactor)\n\n### import & pre-process data\nX <- read.csv('data/CRBirds.csv',header=T,\n              colClasses = c('factor','factor','numeric','factor','character','numeric')) %>%\n  as.data.table\nX <- X[!duplicated(X),]   #removing duplicate rows - not sure what to do with those.\nnames(X)[names(X)=='Spp'] <- 'Species'\nX[,Species:=gsub(' ','_',Species)]\nbird.species <- unique(X$Species)\nX[,LUI:=factor(LUI,levels=c('Forest','Diversified','Intensive'))]\n\ntaxonomy <- read.csv('data/2012-03-04206D-master_taxonomy.csv',header=T,stringsAsFactors = F)\ntiplabels <- taxonomy$TipLabel\ntax <- taxonomy[,c('OscSubOsc','Order','BLFamilyLatin','Clade','TipLabel')]\ntax <- apply(tax,1,paste,collapse='; ')   ##semicolon delimited taxonomies are necessary for taxonomic summaries\ntaxonomy <- data.frame(\"Species\"=tiplabels,'taxonomy'=tax,stringsAsFactors = F)\n\n### Start with a single tree\ntree <- read.tree('data/JETZ TREES/Jetz_with_Furnariidae_March2013__tree1.txt')\n\n\nbird.species[!bird.species %in% tree$tip.label] #18 species not found in tree tip labels\n# [1] \"Veniliornis_fumigatus\"     \"Pipra_coronata\"           \n# [3] \"Xenops_minutus\"            \"Contopus_sp.\"             \n# [5] \"Pionopsitta_haematotis\"    \"Piculus_rubiginosus\"      \n# [7] \"Automolus_rubiginosus\"     \"Buarremon_brunneinucha\"   \n# [9] \"Myrmotherula_fulviventris\" \"Ciccaba_virgata\"          \n# [11] \"Amazilia_sp.\"              \"Empidonax_sp.\"            \n# [13] \"Laterallus_sp.\"            \"Ardea_alba\"               \n# [15] \"Ceryle_torquatus\"          \"Gallinago_delicata\"       \n# [17] \"Ceryle_alcyon\"             \"Buarremon_torquatus\" \n\nX <- X[Species %in% tree$tip.label,]  ## filter dataset to species in tree\nbird.species <- unique(X$Species)\ntree <- drop.tip(tree,setdiff(tree$tip.label,bird.species)) ## trim tree to only species in data\n\n\nX[,Sample:=paste(Transect,Year,Season,LUI,sep='_')]\nX[,N:=Number.of.surveys.per.season.detection..out.of.3.]\n\n### There are two main for generalized phylofactorization of these data\n## (1) algorithm='mStable' - sum counts within groups and use factor contrasts to ID edges best separating species\n## (2) algorithm='phylo' - skip within-group summation. Much more costly\n\n### We'll use the mStable algorithm.\n## While the function gpf() accepts glm-style input of data frames containing all the variables\n## used in regression, the mStable algorithm will convert that data frame into a matrix & operate on it\n## accordingly. To make our workspace easily merged with the mStable phylofactor object,\n## we'll make those matrices. For binoimal regression, need a list containing two matrices: Successes & Failures.\n## In this script, the absence of a species is considered 0 successes, 3 failures.\n\nSuccesses <- phyloframe.to.matrix(X)\n## We'll put the successes & failures in the same order as tree$tip.labels\nSuccesses <- Successes[tree$tip.label,]\nFailures <- 3-Successes\n\n### The meta-data must have rows match each column in Successes.\nMetaData <- X[,c('Sample','Season','LUI','Year','Transect')]\nMetaData <- MetaData[!duplicated(MetaData)]\nMetaData <- MetaData[match(colnames(Successes),Sample),]\n\n\nData <- list('Successes'=Successes,'Failures'=Failures)\npf <- gpf(Data,tree,MetaData=MetaData,frmla.phylo=cbind(Successes,Failures)~Season+phylo*LUI,\n          nfactors=200,ncores=7,algorithm = 'mStable',family=binomial,PartitioningVariables = 'LUI')\n## If we don't set PartitioningVariables='LUI', then gpf will also partition edges based on the deviance\n## from the term phylo all by itself (i.e. edges separating species with a high difference in P{Success} \n## irrespective of how that P{Success} changes with LUI)\n\nMetaData[,LUI_quant:=as.numeric(LUI)]\n\n## We can also use a quantitative model of increasing land-use intensity. The benefit being\n## that, while the phylo*LUI factor above splits differences-of-means in each group, the quant model\n## focuses more on the response slopes to LUI, not the means (i.e. relative difference-of-means)\n\npf_quant <- gpf(Data,tree,MetaData=MetaData,frmla.phylo=cbind(Successes,Failures)~Season+phylo*LUI_quant,\n              nfactors=200,ncores=7,algorithm = 'mStable',family=binomial,PartitioningVariables = 'LUI_quant')\n\nsave(list=ls(),file='workspaces/CR_LUI_mStable_phylofactorization_workspace')\n",
    "created" : 1528564749596.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "225143504",
    "id" : "79480D1D",
    "lastKnownWriteTime" : 1528642418,
    "last_content_update" : 1528642418041,
    "path" : "~/Socolar/BirdPhylofactor/scripts/(1)phylofactorization_of_birds_by_LUI.R",
    "project_path" : "scripts/(1)phylofactorization_of_birds_by_LUI.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}